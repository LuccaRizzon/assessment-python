{% extends "base.html" %}

{% block title %}Challenge 5 - Inventory{% endblock %}

{% block content %}
<div class="container py-5">
  <h1 class="text-center mb-4">Challenge 5: Inventory Manager</h1>

  {% if message %}
    <div class="alert alert-info">{{ message }}</div>
  {% endif %}

  <ul class="nav nav-tabs mb-3" id="inventoryTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'add' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#add" type="button">Add Product</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'remove' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#remove" type="button">Remove Product</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'search' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#search" type="button">Search by Category</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'most_expensive' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#expensive" type="button">Most Expensive</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if active_tab == 'low_stock' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#low" type="button">Low Stock</button>
    </li>
  </ul>

  <div class="tab-content border rounded p-3 bg-white" id="inventoryTabsContent">
    <div class="tab-pane fade {% if active_tab == 'add' %}show active{% endif %}" id="add">
      <form method="POST">
        {{ form.hidden_tag() }}
        <input type="hidden" name="action" value="add">
        <div class="row g-2 mb-3">
          <div class="col">
            <div class="form-group">
              {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else ""), placeholder="Name") }}
              {% if form.name.errors %}
                <div class="invalid-feedback d-block">{{ form.name.errors[0] }}</div>
              {% endif %}
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              {{ form.category(class="form-control" + (" is-invalid" if form.category.errors else ""), placeholder="Category") }}
              {% if form.category.errors %}
                <div class="invalid-feedback d-block">{{ form.category.errors[0] }}</div>
              {% endif %}
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              {{ form.price(class="form-control" + (" is-invalid" if form.price.errors else ""), placeholder="Price") }}
              {% if form.price.errors %}
                <div class="invalid-feedback d-block">{{ form.price.errors[0] }}</div>
              {% endif %}
            </div>
          </div>
          <div class="col">
            <div class="form-group">
              {{ form.quantity(class="form-control" + (" is-invalid" if form.quantity.errors else ""), placeholder="Quantity") }}
              {% if form.quantity.errors %}
                <div class="invalid-feedback d-block">{{ form.quantity.errors[0] }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="text-end">
          {{ form.submit(class="btn btn-success") }}
        </div>
      </form>
    </div>

    <div class="tab-pane fade {% if active_tab == 'remove' %}show active{% endif %}" id="remove">
      <form method="POST">
        <input type="hidden" name="action" value="remove">
        <div class="input-group mt-3">
          <input name="remove_name" class="form-control" list="productList" placeholder="Product name to remove">
          <button class="btn btn-danger">Remove</button>
        </div>
        <datalist id="productList">
          {% for name in inventory.keys() %}
            <option value="{{ name }}">
          {% endfor %}
        </datalist>
      </form>
    </div>

    <div class="tab-pane fade {% if active_tab == 'search' %}show active{% endif %}" id="search">
      <form method="POST" class="mt-3">
        <input type="hidden" name="action" value="search">
        <div class="input-group">
          <input name="search_category" class="form-control" placeholder="Enter category" minlength="2" maxlength="30" required>
          <button class="btn btn-secondary">Search</button>
        </div>
      </form>
    </div>

    <div class="tab-pane fade {% if active_tab == 'most_expensive' %}show active{% endif %}" id="expensive">
      <form method="POST" class="mt-3">
        <input type="hidden" name="action" value="most_expensive">
        <button class="btn btn-warning">Show Most Expensive Product</button>
      </form>
    </div>

    <div class="tab-pane fade {% if active_tab == 'low_stock' %}show active{% endif %}" id="low">
      <form method="POST" class="mt-3">
        <input type="hidden" name="action" value="low_stock">
        <div class="input-group">
          <input name="minimum_stock" class="form-control" type="number" placeholder="Minimum quantity threshold">
          <button class="btn btn-outline-dark">Filter</button>
        </div>
      </form>
    </div>
  </div>

  <hr class="my-4">

  <h4>Inventory</h4>
  <ul class="list-group mb-4">
    {% for name, data in inventory.items() %}
      <li class="list-group-item">
        <strong>{{ name }}</strong> — {{ data.category }} | Price: {{ data.price }} | Quantity: {{ data.quantity }}
      </li>
    {% else %}
      <li class="list-group-item">No products in inventory.</li>
    {% endfor %}
  </ul>

  {% if results %}
    <h4>Results</h4>
    <ul class="list-group">
      {% for item in results %}
        <li class="list-group-item">
          <strong>{{ item.name }}</strong>
          {% if item.category %} — {{ item.category }}{% endif %}
          {% if item.price is not none %} | Price: {{ item.price }}{% endif %}
          {% if item.quantity is not none %} | Quantity: {{ item.quantity }}{% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <div class="text-center mt-4">
    <a href="/" class="btn btn-primary">Back to Home</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function setActiveTab(tab) {
    localStorage.setItem("inventoryTab", tab);
  }

  window.addEventListener("load", function () {
    const savedTab = localStorage.getItem("inventoryTab");
    if (savedTab) {
      const triggerEl = document.querySelector(`[data-bs-target="#${savedTab}"]`);
      if (triggerEl) {
        new bootstrap.Tab(triggerEl).show();
      }
    }
  });
</script>
{% endblock %}
